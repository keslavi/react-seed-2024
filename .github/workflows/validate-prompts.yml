name: Prompt Context Validation

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  validate-prompts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check prompt file currency
      run: |
        echo "Checking prompt file modification dates..."
        find . -name "prompt*.md" -exec ls -la {} \;
        
    - name: Verify commit message format
      run: |
        echo "Checking recent commit messages for prompt references..."
        git log --oneline -5 | grep -i "context:" || echo "‚ö†Ô∏è No recent commits reference context prompts"
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Check if prompt files exist
          const promptFiles = ['prompt.md', 'promptFormhelper.md'];
          const missingPrompts = promptFiles.filter(file => !fs.existsSync(file));
          
          let comment = '## ü§ñ Prompt Context Validation\n\n';
          
          if (missingPrompts.length > 0) {
            comment += `‚ùå **Missing prompt files**: ${missingPrompts.join(', ')}\n\n`;
          } else {
            comment += '‚úÖ **All required prompt files present**\n\n';
          }
          
          // Check for prompt references in PR description
          const prBody = context.payload.pull_request.body || '';
          if (prBody.toLowerCase().includes('context:') || prBody.toLowerCase().includes('prompt')) {
            comment += '‚úÖ **PR description references context prompts**\n\n';
          } else {
            comment += '‚ö†Ô∏è **PR description should reference context prompts**\n\n';
          }
          
          comment += '### üìã Required Format\n';
          comment += '```\n';
          comment += 'Context: prompt.md, promptFormhelper.md\n';
          comment += 'Scope: [Brief description]\n';
          comment += 'Question: [Specific question]\n';
          comment += '```\n\n';
          comment += '### üìö Available Prompts\n';
          comment += '- `prompt.md` - Project conventions and patterns\n';
          comment += '- `promptFormhelper.md` - Form component patterns\n';
          comment += '- `promptTesting.md` - Testing patterns (if exists)\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

